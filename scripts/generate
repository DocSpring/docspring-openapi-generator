#!/bin/bash
set -e
cd "$(dirname "$0")/.."

LANGUAGE="$1"
CONFIG_FILE="config/$LANGUAGE.json"
CLIENT_DIR="clients/$LANGUAGE"

if [ -z "$LANGUAGE" ]; then
  for f in config/*; do
    LANG="$(echo $f | sed -e "s/config\///g" -e "s/\.json//g")"
    if [ "$LANG" = "java" ]; then
      echo "Skipping $LANG for now, not implemented yet."
      continue
    fi
    echo "Generating $LANG client library..."
    ./scripts/generate "$LANG"
  done
  exit
fi

GENERATOR_NAME="formapi-$LANGUAGE"

mkdir -p "examples/$LANGUAGE"
mkdir -p "scripts/$LANGUAGE"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "Could not find $CONFIG_FILE"
  ./openapi-generator-cli config-help -g "$LANGUAGE"
  exit 1
fi

# Preserve any vendored dependencies between rebuilds
case "$LANGUAGE" in
  php)
    for f in $CLIENT_DIR/*; do
      if ! [[ "$f" = *'/vendor' ]]; then rm -r $f; fi
    done;;
  csharp)
    for f in $CLIENT_DIR/*; do
      if ! [[ "$f" = *'/nuget.exe' ]] && ! [[ "$f" = *'/packages' ]]; then rm -r $f; fi
    done;;
  javascript)
    for f in $CLIENT_DIR/*; do
      if ! [[ "$f" = *'/node_modules' ]]; then rm -r $f; fi
    done;;
  *)
    rm -rf "$CLIENT_DIR"
esac


./openapi-generator-cli generate \
  --input-spec ../form_api/swagger/v1/swagger.json \
  --generator-name "$GENERATOR_NAME" \
  --config "$CONFIG_FILE" \
  --output "$CLIENT_DIR"

if [ -f "./scripts/$LANGUAGE/post-generate" ]; then
  "./scripts/$LANGUAGE/post-generate"
fi
